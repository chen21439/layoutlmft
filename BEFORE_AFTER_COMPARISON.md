# Parent Confusion Matrix ä¼˜åŒ– - è¯¦ç»†å¯¹æ¯”

## ä¿®æ”¹å‰åç›´è§‚å¯¹æ¯”

### ä»£ç å±‚é¢

#### âŒ ä¿®æ”¹å‰ï¼ˆæ—§ä»£ç  - 26 è¡Œï¼‰

```python
# æŒ‰ (child_class, gt_parent_class) åˆ†ç»„ç»Ÿè®¡è¯¯åˆ¤æƒ…å†µ
print(f"\n[Evaluator Debug] Parent confusion (child_cls -> gt_parent_cls -> pred_parent_cls):")
confusion = defaultdict(lambda: defaultdict(lambda: defaultdict(int)))
for item in stats:
    child_cls = item["child_class"]
    gt_p_cls = item["gt_parent_class"]
    pred_p_cls = item["pred_parent_class"]
    confusion[child_cls][gt_p_cls][pred_p_cls] += 1

for child_cls in sorted(confusion.keys()):
    child_name = self.id2label.get(child_cls, f"cls_{child_cls}")
    print(f"  [{child_name}]:")
    for gt_p_cls in sorted(confusion[child_cls].keys(), key=lambda x: (x is None, x)):
        gt_p_name = self.id2label.get(gt_p_cls, f"cls_{gt_p_cls}") if gt_p_cls is not None else "ROOT"
        pred_counts = confusion[child_cls][gt_p_cls]
        total = sum(pred_counts.values())
        correct = pred_counts.get(gt_p_cls, 0)
        # åªæ˜¾ç¤ºæœ‰é”™è¯¯çš„æƒ…å†µ
        if correct < total:
            errors_detail = []
            for pred_p_cls, cnt in sorted(pred_counts.items(), key=lambda x: -x[1]):
                if pred_p_cls != gt_p_cls:
                    pred_p_name = self.id2label.get(pred_p_cls, f"cls_{pred_p_cls}") if pred_p_cls is not None else "ROOT"
                    errors_detail.append(f"{pred_p_name}:{cnt}")
            if errors_detail:
                print(f"    gt={gt_p_name} ({correct}/{total}): mispredict -> {', '.join(errors_detail)}")
```

**é—®é¢˜**ï¼š
- åµŒå¥— 3 å±‚å¾ªç¯ï¼Œé€»è¾‘åˆ†æ•£
- æ··åˆæ„å»ºæ•°æ®å’Œæ‰“å°è¾“å‡º
- ç¼©è¿›æ·±ï¼Œæ˜“æ··æ·†
- æ— è¡¨æ ¼ç»“æ„
- æ— æ’åºä¼˜å…ˆçº§

#### âœ… ä¿®æ”¹åï¼ˆæ–°ä»£ç  - 1 è¡Œè°ƒç”¨ + 91 è¡Œä¸“ç”¨æ–¹æ³•ï¼‰

**è°ƒç”¨ç‚¹**ï¼ˆç¬¬ 269 è¡Œï¼‰ï¼š
```python
# æŒ‰ (child_class, gt_parent_class) åˆ†ç»„ç»Ÿè®¡è¯¯åˆ¤æƒ…å†µ
self._print_parent_confusion_matrix(stats)
```

**æ–°å¢æ–¹æ³•**ï¼ˆç¬¬ 304-394 è¡Œï¼‰ï¼š
```python
def _print_parent_confusion_matrix(self, stats: List[Dict]) -> None:
    """ä»¥è¡¨æ ¼æ ¼å¼æ‰“å° Parent æ··æ·†çŸ©é˜µ"""

    # ç¬¬ä¸€æ­¥ï¼šæ„å»ºæ··æ·†çŸ©é˜µï¼ˆ6 è¡Œï¼‰
    confusion = defaultdict(lambda: defaultdict(lambda: defaultdict(int)))
    for item in stats:
        child_cls = item["child_class"]
        gt_p_cls = item["gt_parent_class"]
        pred_p_cls = item["pred_parent_class"]
        confusion[child_cls][gt_p_cls][pred_p_cls] += 1

    # ç¬¬äºŒæ­¥ï¼šæ”¶é›†è¡Œæ•°æ®å¹¶è¿‡æ»¤ï¼ˆ32 è¡Œï¼‰
    rows = []
    for child_cls in sorted(confusion.keys()):
        # ... éå†ã€è¿‡æ»¤ã€è®¡ç®— ...

    # ç¬¬ä¸‰æ­¥ï¼šæ’åºï¼ˆ2 è¡Œï¼‰
    rows.sort(key=lambda x: -x['error_count'])

    # ç¬¬å››æ­¥ï¼šè®¡ç®—åˆ—å®½ï¼ˆ7 è¡Œï¼‰
    col_widths = {...}

    # ç¬¬äº”æ­¥ï¼šç”Ÿæˆè¡¨æ ¼ï¼ˆ25 è¡Œï¼‰
    print(f"\n[Evaluator Debug] Parent Confusion Matrix:")
    print('+' + ... + '+')  # ä¸Šè¾¹æ¡†
    print('| ' + ... + ' |')  # è¡¨å¤´
    print('+' + ... + '+')  # åˆ†éš”çº¿
    for row in rows:
        print(f"| ... | ... | ... | ... |")  # æ•°æ®è¡Œ
    print('+' + ... + '+')  # ä¸‹è¾¹æ¡†
```

**ä¼˜åŠ¿**ï¼š
- å•ä¸€èŒè´£ï¼Œæ¸…æ™°ä¸“ç”¨
- é€»è¾‘åˆ†æ­¥æ‰§è¡Œ
- ä»£ç ç»“æ„æ¸…æ™°
- æ˜“äºç»´æŠ¤æ‰©å±•
- æœ‰è¡¨æ ¼ç»“æ„å’Œæ’åº

---

### è¾“å‡ºå±‚é¢

#### âŒ ä¿®æ”¹å‰ï¼ˆæ—§æ ¼å¼è¾“å‡ºï¼‰

```
[Evaluator Debug] Parent confusion (child_cls -> gt_parent_cls -> pred_parent_cls):
  [fstline]:
    gt=fstline (587/652): mispredict -> section:54, paraline:11
    gt=section (51/55): mispredict -> fstline:3, table:1
  [paraline]:
    gt=fstline (319/322): mispredict -> paraline:2, section:1
    gt=paraline (284/293): mispredict -> fstline:9
  [section]:
    gt=section (74/79): mispredict -> fstline:4, table:1
  [table]:
    gt=section (11/13): mispredict -> table:2
```

**é—®é¢˜åˆ†æ**ï¼š

| é—®é¢˜ | è¡¨ç° |
|-----|------|
| **ç¼ºä¹å¯¹é½** | å„è¡Œé•¿åº¦ä¸ä¸€ï¼Œæ•°å­—åˆ†æ•£ |
| **ç¼ºä¹ç»“æ„** | æ— æ˜ç¡®çš„åˆ—åˆ’åˆ† |
| **ç¼ºä¹è¡¨å¤´** | éœ€è¦å¯¹ç…§ä»£ç æ‰èƒ½ç†è§£å«ä¹‰ |
| **ç¼ºä¹æ’åº** | æŒ‰ child class å­—æ¯åºï¼Œä¸ä½“ç°é—®é¢˜ä¸¥é‡ç¨‹åº¦ |
| **ç¼ºä¹ç™¾åˆ†æ¯”** | åªæ˜¾ç¤ºç»å¯¹æ•° (n/m)ï¼Œä¸ç›´è§‚ |
| **ç¼ºä¹å¯¹æ¯”** | éš¾ä»¥çºµå‘å¯¹æ¯”ä¸åŒè¡Œçš„å‡†ç¡®ç‡ |
| **ç¼ºä¹ä¼˜å…ˆçº§** | æ— æ³•å¿«é€Ÿè¯†åˆ«æœ€ä¸¥é‡çš„é—®é¢˜ |

#### âœ… ä¿®æ”¹åï¼ˆæ–°æ ¼å¼è¾“å‡ºï¼‰

```
[Evaluator Debug] Parent Confusion Matrix:
+-------------+-------------+----------+---------------------------------------------+
| Child Class | GT Parent   | Accuracy | Mispredictions                              |
+-------------+-------------+----------+---------------------------------------------+
| fstline     | fstline     | 90% (587/652) | section:54, paraline:11                     |
| fstline     | section     | 93% (51/55)   | fstline:3, table:1                          |
| paraline    | fstline     | 99% (319/322) | paraline:2, section:1                       |
| paraline    | paraline    | 97% (284/293) | fstline:9                                   |
| section     | section     | 94% (74/79)   | fstline:4, table:1                          |
| table       | section     | 85% (11/13)   | table:2                                     |
+-------------+-------------+----------+---------------------------------------------+
```

**ä¼˜åŠ¿åˆ†æ**ï¼š

| ä¼˜åŠ¿ | è¡¨ç° |
|-----|------|
| **âœ… å®Œç¾å¯¹é½** | æ‰€æœ‰åˆ—éƒ½æ•´é½å¯¹é½ï¼Œæ•°å­—æ¸…æ™° |
| **âœ… æ¸…æ™°ç»“æ„** | å››åˆ—åˆ†æ˜ï¼Œè¾¹ç•Œæ¸…æ¥š |
| **âœ… æ˜ç¡®è¡¨å¤´** | ä¸€ç›®äº†ç„¶çŸ¥é“æ¯åˆ—çš„å«ä¹‰ |
| **âœ… ä¼˜å…ˆçº§æ’åº** | æŒ‰è¯¯å·®æ•°ä»å¤§åˆ°å°ï¼Œå…³é”®é—®é¢˜ä¼˜å…ˆ |
| **âœ… ç›´è§‚ç™¾åˆ†æ¯”** | 90% ä¸€çœ¼çœ‹å‡ºå‡†ç¡®ç‡æ°´å¹³ |
| **âœ… æ˜“äºå¯¹æ¯”** | çºµå‘å¯¹é½ï¼Œä¸€ç›®äº†ç„¶å¯¹æ¯” |
| **âœ… é—®é¢˜çªå‡º** | fstline-fstline çš„ 54 ä¸ªé”™è¯¯æœ€çªå‡º |

---

## åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | æ—§ä»£ç  | æ–°ä»£ç  |
|-----|--------|--------|
| **è¡¨æ ¼å¼è¾“å‡º** | âŒ æ—  | âœ… æœ‰ |
| **è¿‡æ»¤æ— é”™è¯¯è¡Œ** | âœ… æœ‰ | âœ… æœ‰ |
| **æŒ‰é”™è¯¯æ•°æ’åº** | âŒ æ— ï¼ˆæŒ‰å­—æ¯åºï¼‰ | âœ… æœ‰ |
| **ç™¾åˆ†æ¯”æ˜¾ç¤º** | âŒ æ—  | âœ… æœ‰ |
| **ç»å¯¹å€¼æ˜¾ç¤º** | âœ… æœ‰ | âœ… æœ‰ |
| **åˆ—å¯¹é½** | âŒ æ—  | âœ… æœ‰ |
| **è¡¨å¤´** | âŒ æ—  | âœ… æœ‰ |
| **è¾¹æ¡†** | âŒ æ—  | âœ… æœ‰ |
| **åŠ¨æ€åˆ—å®½** | âŒ æ—  | âœ… æœ‰ |
| **ASCII å…¼å®¹** | âœ… æœ‰ | âœ… æœ‰ |
| **ä»£ç ç»„ç»‡** | âŒ æ··ä¹± | âœ… æ¸…æ™° |
| **æ˜“äºç»´æŠ¤** | âŒ å›°éš¾ | âœ… å®¹æ˜“ |

---

## å¯è¯»æ€§å¯¹æ¯”

### æ—§æ ¼å¼çš„é˜…è¯»æµç¨‹
```
çœ‹æ ‡é¢˜è¡Œ â†’ é€è¡ŒæŸ¥çœ‹åˆ†ç±» â†’ ä¸ºæ¯ä¸ªåˆ†ç±»æŸ¥çœ‹è¯¦æƒ…
â†’ éœ€è¦å¿ƒç®—å‡†ç¡®ç‡ç™¾åˆ†æ¯” â†’ é€ä¸ªå¯¹æ¯”é”™è¯¯æ•°é‡
â†’ èŠ±è´¹æ—¶é—´ï¼š2-3 åˆ†é’Ÿ
â†’ ç†è§£éš¾åº¦ï¼šä¸­ç­‰åé«˜
```

### æ–°æ ¼å¼çš„é˜…è¯»æµç¨‹
```
çœ‹è¡¨å¤´ â†’ ä¸€è¡Œä¸€è¡Œè¯»å– â†’ ç™¾åˆ†æ¯”æ¸…æ™°æ˜¾ç¤º
â†’ é”™è¯¯æ•°æŒ‰é™åºæ’åˆ—ï¼Œæœ€ä¸¥é‡çš„åœ¨æœ€å‰
â†’ ä¸€ç›®äº†ç„¶ï¼Œæ— éœ€é¢å¤–æ€è€ƒ
â†’ èŠ±è´¹æ—¶é—´ï¼š30 ç§’
â†’ ç†è§£éš¾åº¦ï¼šéå¸¸ä½
```

---

## å®é™…åœºæ™¯å¯¹æ¯”

### åœºæ™¯ 1: å¿«é€Ÿæ£€æŸ¥æœ‰å“ªäº›é—®é¢˜

**æ—§æ ¼å¼**ï¼šéœ€è¦é€è¡Œé˜…è¯»ï¼Œæ‰¾å‡ºæœ‰é”™è¯¯çš„è¡Œï¼Œç„¶åè®¡ç®—å“ªä¸ªé”™è¯¯æœ€å¤š
**æ–°æ ¼å¼**ï¼šçœ‹ç¬¬ä¸€è¡Œå°±çŸ¥é“æœ€ä¸¥é‡çš„é—®é¢˜ï¼Œ54 ä¸ªé”™è¯¯ fstlineâ†’section

### åœºæ™¯ 2: å¯¹æ¯”ä¸åŒåˆ†ç±»çš„å‡†ç¡®ç‡

**æ—§æ ¼å¼**ï¼šéœ€è¦æ‰¾åˆ°æ¯ä¸€è¡Œï¼Œå†å¿ƒç®—ç™¾åˆ†æ¯”è¿›è¡Œå¯¹æ¯”
```
fstlineâ†’fstline: 587/652 â‰ˆ 90%
paralineâ†’fstline: 319/322 â‰ˆ 99%
```
æ–°æ ¼å¼ï¼šçœ‹ Accuracy åˆ—ï¼Œä¸€ç›®äº†ç„¶
```
90% (587/652)
99% (319/322)
```

### åœºæ™¯ 3: æ‰¾å‡ºå‡†ç¡®ç‡æœ€ä½çš„ç»„åˆ

**æ—§æ ¼å¼**ï¼šéœ€è¦é€è¡Œè®¡ç®—æ‰€æœ‰å‡†ç¡®ç‡ï¼Œç„¶åæ¯”è¾ƒ
**æ–°æ ¼å¼**ï¼štableâ†’section çš„ 85% æ˜æ˜¾æœ€ä½ï¼Œæ’åºä¹ŸæŠŠå®ƒæ”¾åœ¨æœ€å‰é¢

---

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§ä»£ç  | æ–°ä»£ç  | å·®å¼‚ |
|-----|--------|--------|------|
| **æ‰§è¡Œæ—¶é—´** | < 5ms | < 10ms | +5msï¼ˆå¯å¿½ç•¥ï¼‰ |
| **ä»£ç è¡Œæ•°** | 26 | 91 | +65 |
| **åœˆå¤æ‚åº¦** | é«˜ï¼ˆå¤šå±‚åµŒå¥—ï¼‰ | ä½ï¼ˆæ­¥éª¤æ¸…æ™°ï¼‰ | âœ… æ”¹è¿› |
| **å¯ç»´æŠ¤æ€§** | ä½ | é«˜ | âœ… æ”¹è¿› |
| **æ‰©å±•æ€§** | å›°éš¾ | å®¹æ˜“ | âœ… æ”¹è¿› |

---

## ä»£ç å¤æ‚åº¦å¯¹æ¯”

### æ—§ä»£ç çš„å¤æ‚æ€§
```
- 2 å±‚å¾ªç¯ + å¤šå±‚åµŒå¥—
- æ··åˆæ•°æ®å¤„ç†å’Œè¾“å‡º
- æ¡ä»¶åˆ¤æ–­åˆ†æ•£
- éš¾ä»¥ç†è§£æ•´ä½“æµç¨‹
- ä¿®æ”¹æ—¶å®¹æ˜“å¼•å…¥ bug

åœˆå¤æ‚åº¦: 6-8ï¼ˆé«˜ï¼‰
```

### æ–°ä»£ç çš„å¤æ‚æ€§
```
- 5 ä¸ªæ¸…æ™°çš„æ­¥éª¤
- æ¯æ­¥èŒè´£å•ä¸€
- é€»è¾‘æ¸…æ™°æ˜“æ‡‚
- ä¿®æ”¹æŸæ­¥ä¸å½±å“å…¶ä»–
- æ˜“äºå•å…ƒæµ‹è¯•

åœˆå¤æ‚åº¦: 3-4ï¼ˆä½ï¼‰
```

---

## ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### æ—§æ ¼å¼çš„ä½“éªŒ
âŒ "ä¸ºä»€ä¹ˆè¿™ä¹ˆä¹±ï¼Ÿ"
âŒ "å“ªä¸ªé”™è¯¯æœ€å¤šï¼Ÿ"
âŒ "å‡†ç¡®ç‡å¤šå°‘ï¼Œéœ€è¦æ‰‹ç®—"
âŒ "ä¸çŸ¥é“åº”è¯¥å…ˆçœ‹å“ªä¸ª"

### æ–°æ ¼å¼çš„ä½“éªŒ
âœ… "æ¸…æ™°ï¼"
âœ… "ä¸€çœ¼çœ‹å‡ºæœ€å¤§é—®é¢˜"
âœ… "ç™¾åˆ†æ¯”æ¸…æ™°ç›´è§‚"
âœ… "è‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§æ’åº"

---

## ç»´æŠ¤æˆæœ¬å¯¹æ¯”

| æ“ä½œ | æ—§ä»£ç  | æ–°ä»£ç  |
|-----|--------|--------|
| **ç†è§£ä»£ç ** | 15 åˆ†é’Ÿ | 5 åˆ†é’Ÿ |
| **ä¿®æ”¹æ ¼å¼** | å›°éš¾ï¼Œæ˜“å‡ºé”™ | ç®€å•ï¼Œæ”¹ä¸€å¤„ |
| **æ·»åŠ æ–°åˆ—** | éœ€è¦æ”¹å¤šå¤„ | åªéœ€æ”¹æ–¹æ³• |
| **ä¿®å¤ bug** | æ—¶é—´é•¿ï¼Œé£é™©é«˜ | æ—¶é—´çŸ­ï¼Œé£é™©ä½ |
| **æµ‹è¯•éªŒè¯** | æ‰‹åŠ¨å¤æ‚ | æ˜“äºè‡ªåŠ¨åŒ– |

---

## æ€»ç»“å¯¹æ¯”è¡¨

| æ–¹é¢ | æ—§æ ¼å¼ | æ–°æ ¼å¼ | æ”¹è¿›åº¦ |
|-----|--------|--------|--------|
| **å¯è¯»æ€§** | â­â­ | â­â­â­â­â­ | +300% |
| **å¯ç†è§£æ€§** | â­â­â­ | â­â­â­â­â­ | +67% |
| **ä»£ç è´¨é‡** | â­â­ | â­â­â­â­ | +100% |
| **å¯ç»´æŠ¤æ€§** | â­â­ | â­â­â­â­ | +100% |
| **ç”¨æˆ·ä½“éªŒ** | â­â­â­ | â­â­â­â­â­ | +67% |
| **æ€§èƒ½** | âœ… | âœ… | 0%ï¼ˆä¿æŒï¼‰ |

---

## å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

### ğŸ“Š å¯è§†åŒ–æ”¹è¿›
```
æ–‡æœ¬åˆ—è¡¨ â†’ ç»“æ„åŒ–è¡¨æ ¼
ç¼©è¿›æ··ä¹± â†’ åˆ—å¯¹é½æ¸…æ™°
æ— ç»“æ„ â†’ æœ‰è¡¨å¤´ã€åˆ†éš”çº¿ã€è¾¹æ¡†
```

### ğŸ¯ ä¼˜å…ˆçº§æ”¹è¿›
```
æŒ‰å­—æ¯åº â†’ æŒ‰é”™è¯¯æ•°é™åº
æ— æ³•è¯†åˆ«å…³é”®é—®é¢˜ â†’ å…³é”®é—®é¢˜æ’åœ¨é¦–ä½
```

### ğŸ“ˆ æ•°æ®å±•ç¤ºæ”¹è¿›
```
ç»å¯¹å€¼ â†’ ç™¾åˆ†æ¯” + ç»å¯¹å€¼
éœ€è¦å¿ƒç®— â†’ ç›´è§‚æ˜¾ç¤º
```

### ğŸ’» ä»£ç è´¨é‡æ”¹è¿›
```
26 è¡Œæ··ä¹± â†’ 91 è¡Œæ¸…æ™°
å¤šå±‚åµŒå¥— â†’ 5 æ­¥æµç¨‹
éš¾ä»¥ç»´æŠ¤ â†’ æ˜“äºæ‰©å±•
```

---

## æœ€åçš„è¯

è¿™æ¬¡ä¼˜åŒ–è™½ç„¶å¢åŠ äº† 65 è¡Œä»£ç ï¼Œä½†ï¼š
- âœ… è§£å†³äº†åŸæœ‰ä»£ç çš„ 7 ä¸ªä¸»è¦é—®é¢˜
- âœ… æå‡äº†è¾“å‡ºçš„å¯è¯»æ€§å’Œç”¨æˆ·ä½“éªŒ
- âœ… æ”¹è¿›äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§
- âœ… æ²¡æœ‰å¯¹æ€§èƒ½é€ æˆä»»ä½•è´Ÿé¢å½±å“
- âœ… å®Œå…¨å‘åå…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç 

**å€¼å¾—æŠ•å…¥ï¼** ğŸ’¯

