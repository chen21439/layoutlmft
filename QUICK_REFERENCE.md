# Parent Confusion Matrix ä¼˜åŒ– - å¿«é€Ÿå‚è€ƒ

## ä»€ä¹ˆæ”¹å˜äº†ï¼Ÿ

### è¾“å‡ºæ ¼å¼ä»è¿™æ ·ï¼š
```
[Evaluator Debug] Parent confusion (child_cls -> gt_parent_cls -> pred_parent_cls):
  [fstline]:
    gt=fstline (587/652): mispredict -> section:54, paraline:11
    gt=section (51/55): mispredict -> fstline:3, table:1
```

### å˜æˆè¿™æ ·ï¼š
```
[Evaluator Debug] Parent Confusion Matrix:
+-------------+-------------+----------+---------------------------------------------+
| Child Class | GT Parent   | Accuracy | Mispredictions                              |
+-------------+-------------+----------+---------------------------------------------+
| fstline     | fstline     | 90% (587/652) | section:54, paraline:11                     |
| fstline     | section     | 93% (51/55)   | fstline:3, table:1                          |
+-------------+-------------+----------+---------------------------------------------+
```

## ä¿®æ”¹äº†å“ªä¸ªæ–‡ä»¶ï¼Ÿ

**æ–‡ä»¶**: `/root/code/layoutlmft/examples/stage/engines/evaluator.py`

**å…·ä½“æ”¹åŠ¨**:
- ç¬¬ 269 è¡Œï¼šè°ƒç”¨ `self._print_parent_confusion_matrix(stats)`
- ç¬¬ 304-394 è¡Œï¼šæ–°å¢ `_print_parent_confusion_matrix()` æ–¹æ³•

## æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

| å¯¹æ¯”é¡¹ | æ—§æ ¼å¼ | æ–°æ ¼å¼ |
|------|--------|--------|
| **å¯è¯»æ€§** | ğŸ“ æ–‡æœ¬åˆ—è¡¨ | ğŸ“Š è¡¨æ ¼å½¢å¼ |
| **ç»“æ„** | åµŒå¥—å¤šå±‚ | å¹³é“ºæ¸…æ™° |
| **å¯¹é½** | éš¾ä»¥å¯¹æ¯” | åˆ—å¯¹é½ï¼Œæ˜“æ¯”è¾ƒ |
| **æ’åº** | æŒ‰ child class | æŒ‰è¯¯å·®æ•° |
| **ç™¾åˆ†æ¯”** | æ˜¾ç¤º `(n/m)` | æ˜¾ç¤º `xx% (n/m)` |
| **æ‰«è¯»** | éœ€é€è¡Œé˜…è¯» | ä¸€ç›®äº†ç„¶ |

## æ ¸å¿ƒç‰¹æ€§

### 1ï¸âƒ£ åªæ˜¾ç¤ºæœ‰é”™è¯¯çš„è¡Œ
```python
if correct < total:  # è¿‡æ»¤
    # æ·»åŠ åˆ°è¡¨æ ¼
```

### 2ï¸âƒ£ æŒ‰é”™è¯¯æ•°æ’åº
```
é”™è¯¯54ä¸ª â”
é”™è¯¯3ä¸ª  â”œâ”€ ç”±å¤§åˆ°å°æ’åº
é”™è¯¯2ä¸ª  â”´
```

### 3ï¸âƒ£ å‡†ç¡®ç‡ç›´è§‚
```
90% (587/652)  # ç™¾åˆ†æ¯” + ç»å¯¹å€¼
```

### 4ï¸âƒ£ ASCII å…¼å®¹
```
+---+---+---+  # ä¸ç”¨ Unicodeï¼Œå…¼å®¹æ‰€æœ‰ç»ˆç«¯
| A | B | C |
+---+---+---+
```

## å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| **Child Class** | å­å…ƒç´ çš„ç±»åˆ« | `fstline`, `paraline`, `section` |
| **GT Parent** | æ ‡å‡†ç­”æ¡ˆä¸­çš„çˆ¶ç±»åˆ« | `fstline`, `ROOT` |
| **Accuracy** | æ­£ç¡®ç‡ï¼Œç™¾åˆ†æ¯”+ç»å¯¹æ•° | `90% (587/652)` |
| **Mispredictions** | æ¨¡å‹è¯¯åˆ¤çš„åˆ†å¸ƒ | `section:54, paraline:11` |

## ä½¿ç”¨ç¤ºä¾‹

```python
from examples.stage.engines.evaluator import Evaluator

# åˆ›å»ºè¯„ä¼°å™¨
evaluator = Evaluator(model, device)

# å¯ç”¨ debug æ¨¡å¼
output = evaluator.evaluate(
    dataloader,
    debug=True,      # çœ‹åˆ°æ–°çš„è¡¨æ ¼è¾“å‡º
    verbose=True     # æˆ–è€…ç”¨ verbose=True
)
```

## ä»£ç ä½ç½®é€ŸæŸ¥

| å†…å®¹ | ä½ç½® |
|-----|------|
| æ–¹æ³•è°ƒç”¨ | ç¬¬ 269 è¡Œ |
| æ–¹æ³•å®ç° | ç¬¬ 304-394 è¡Œ |
| æ··æ·†çŸ©é˜µæ„å»º | ç¬¬ 315-320 è¡Œ |
| è¡Œæ•°æ®æ”¶é›† | ç¬¬ 322-353 è¡Œ |
| é”™è¯¯æ’åº | ç¬¬ 355-356 è¡Œ |
| è¡¨æ ¼ç”Ÿæˆ | ç¬¬ 370-394 è¡Œ |

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆåªæ˜¾ç¤ºæœ‰é”™è¯¯çš„è¡Œï¼Ÿ
A: é¿å…è¡¨æ ¼è¿‡é•¿ï¼Œèšç„¦äºéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚å®Œå…¨æ­£ç¡®çš„è¡Œï¼ˆ100% å‡†ç¡®ç‡ï¼‰ä¸éœ€è¦åˆ†æã€‚

### Q: ä¸ºä»€ä¹ˆè¦æŒ‰é”™è¯¯æ•°æ’åºï¼Ÿ
A: è¿™æ ·å½±å“æœ€å¤§çš„é—®é¢˜æ’åœ¨å‰é¢ï¼Œä¾¿äºä¼˜å…ˆçº§æ’åºå’Œé—®é¢˜è§£å†³ã€‚

### Q: æ”¯æŒ Unicode å­—ç¬¦å—ï¼Ÿ
A: å¦ã€‚ä½¿ç”¨çº¯ ASCII å­—ç¬¦ï¼ˆ`+`, `-`, `|`ï¼‰ç¡®ä¿æ‰€æœ‰ç»ˆç«¯éƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºã€‚

### Q: è¿™ä¸ªæ”¹åŠ¨ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
A: å®Œå…¨æ²¡æœ‰ã€‚è¿™åªæ˜¯è¾“å‡ºæ ¼å¼æ”¹å˜ï¼Œä»…åœ¨è°ƒè¯•æ—¶æ‰§è¡Œï¼Œå¯¹æ¨¡å‹è¯„ä¼°æ€§èƒ½æ— å½±å“ã€‚

### Q: å‘åå…¼å®¹å—ï¼Ÿ
A: å®Œå…¨å…¼å®¹ã€‚æ²¡æœ‰ API å˜æ›´ï¼ŒåŸæœ‰ä»£ç å¯ç›´æ¥ä½¿ç”¨ï¼Œåªæ˜¯è¾“å‡ºæ ¼å¼æ›´å¥½çœ‹ã€‚

## ä¸€é”®å¯¹æ¯”

**æ—§ä»£ç **ï¼ˆ26 è¡Œï¼‰ï¼š
```python
print(f"\n[Evaluator Debug] Parent confusion (...):")
confusion = defaultdict(...)
for item in stats:
    # ... åµŒå¥—å¾ªç¯å’Œæ¡ä»¶åˆ¤æ–­
    if correct < total:
        errors_detail = []
        for pred_p_cls, cnt in sorted(...):
            if pred_p_cls != gt_p_cls:
                errors_detail.append(...)
        if errors_detail:
            print(f"    gt={gt_p_name} ({correct}/{total}): mispredict -> {', '.join(errors_detail)}")
```

**æ–°ä»£ç **ï¼ˆ1 è¡Œè°ƒç”¨ï¼‰ï¼š
```python
self._print_parent_confusion_matrix(stats)
```

æ–°å¢ä¸“ç”¨æ–¹æ³•ï¼ˆ91 è¡Œï¼‰å¤„ç†æ‰€æœ‰é€»è¾‘ï¼Œç»“æ„æ¸…æ™°ã€‚

## æ•ˆæœå±•ç¤º

### å°è§„æ¨¡æ•°æ®
```
[Evaluator Debug] Parent Confusion Matrix:
+----------+----------+----------+-------------------+
| Child    | GT       | Accuracy | Mispredictions    |
+----------+----------+----------+-------------------+
| line1    | parent1  | 95% (19/20) | parent2:1          |
| line2    | parent1  | 85% (17/20) | parent2:2, parent3:1 |
+----------+----------+----------+-------------------+
```

### å¤§è§„æ¨¡æ•°æ®ï¼ˆè‡ªé€‚åº”åˆ—å®½ï¼‰
```
[Evaluator Debug] Parent Confusion Matrix:
+---------------------+---------------------+----------+---------------------------------------------+
| Child Class         | GT Parent           | Accuracy | Mispredictions                              |
+---------------------+---------------------+----------+---------------------------------------------+
| very_long_class_name| another_long_name   | 90% (587/652) | class_a:54, class_b:11, class_c:8           |
+---------------------+---------------------+----------+---------------------------------------------+
```

åˆ—å®½è‡ªåŠ¨è°ƒæ•´ï¼Œå†…å®¹ä¸ä¼šè¢«æˆªæ–­ã€‚

## è°ƒè¯•æŠ€å·§

### åªçœ‹æœ‰é”™è¯¯çš„è¡Œ
```python
# è‡ªåŠ¨è¿‡æ»¤ï¼Œæ— éœ€é¢å¤–ä»£ç 
# if correct < total: å†…ç½®ç­›é€‰
```

### å¿«é€Ÿæ‰¾åˆ°æœ€ä¸¥é‡çš„é—®é¢˜
```python
# æŒ‰é”™è¯¯æ•°æ’åºï¼Œç¬¬ä¸€è¡Œé”™è¯¯æœ€å¤š
# æœ€å¤šçš„é”™è¯¯æ’åœ¨æœ€å‰é¢
```

### è®¡ç®—æ€»ä½“å‡†ç¡®ç‡
```python
# Accuracy åˆ—ä¸­çš„ç™¾åˆ†æ¯”
# è®¡ç®—æ‰€æœ‰è¡Œçš„åŠ æƒå¹³å‡å€¼
total_correct = sum(row['correct'] for row in rows)
total_samples = sum(row['total'] for row in rows)
overall_accuracy = 100 * total_correct / total_samples
```

## æ€»ç»“

âœ¨ **æ”¹åŠ¨**: ä¼˜åŒ–æ—¥å¿—è¾“å‡ºæ ¼å¼
ğŸ“ **ä½ç½®**: `/root/code/layoutlmft/examples/stage/engines/evaluator.py`
ğŸ¯ **æ•ˆæœ**: ä»æ–‡æœ¬åˆ—è¡¨ â†’ è¡¨æ ¼å½¢å¼ï¼Œæå‡å¯è¯»æ€§å’Œåˆ†ææ•ˆç‡
âš¡ **å…¼å®¹**: 100% å‘åå…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç 
ğŸ“Š **æ’åº**: è‡ªåŠ¨æŒ‰è¯¯å·®æ•°ä»å¤§åˆ°å°æ’åºï¼Œå…³é”®é—®é¢˜ä¼˜å…ˆæ˜¾ç¤º

---

éœ€è¦æ›´å¤šç»†èŠ‚ï¼ŸæŸ¥çœ‹ï¼š
- ğŸ“„ `OPTIMIZATION_SUMMARY.md` - æ€»ä½“ä»‹ç»
- ğŸ“‹ `CHANGES_DETAIL.md` - è¯¦ç»†å¯¹æ¯”
- âœ… `MODIFICATION_CHECKLIST.md` - å®Œæ•´æ£€æŸ¥æ¸…å•
- ğŸ§ª `test_confusion_matrix.py` - æµ‹è¯•è„šæœ¬

