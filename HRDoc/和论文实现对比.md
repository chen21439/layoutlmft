论文 vs 当前联合训练实现 对比

  已对齐的部分 ✅

  | 模块        | 论文                             | 当前实现                                  | 状态      |
  |-------------|----------------------------------|-------------------------------------------|-----------|
  | GRU Decoder | 结构感知GRU                      | ParentFinderGRU                           | ✅ 已实现 |
  | Soft-Mask   | Child-Parent Distribution Matrix | ChildParentDistributionMatrix             | ✅ 已实现 |
  | 关系类型    | Connect, Contain, Equality (3种) | connect, contain, equality (3种)          | ✅ 一致   |
  | 总损失公式  | L = L_cls + α₁L_par + α₂L_rel    | L = λ_clsL_cls + λ_parL_par + λ_rel*L_rel | ✅ 一致   |
  | 父节点损失  | Cross-Entropy                    | Cross-Entropy                             | ✅ 一致   |
  | 关系损失    | Focal Loss                       | FocalLoss (gamma=2.0)                     | ✅ 一致   |
  | 梯度反传    | 端到端联合训练                   | Stage 3/4 loss 可回传到 Stage 1           | ✅ 已实现 |

  存在差异/需确认 ⚠️

  | 模块            | 论文                       | 当前实现                     | 差异        |
  |-----------------|----------------------------|------------------------------|-------------|
  | 分类损失        | Focal Loss                 | LayoutXLM 默认 (CE)          | ⚠️ 不同     |
  | Text Embedding  | Sentence-BERT + Linear     | LayoutXLM hidden states      | ⚠️ 架构不同 |
  | Visual Backbone | ResNet-50 + FPN + RoIAlign | LayoutXLM (ResNet-101 + FPN) | 类似        |
  | Encoder         | 自定义多模态Transformer    | LayoutXLM 预训练模型         | 架构不同    |

  需要对齐的功能

  1. 分类 Focal Loss
    - 论文用 Focal Loss 处理类别不平衡
    - 当前 Stage 1 用的是 balanced_loss.py 可选，但联合训练的 train_joint.py 只对关系分类用了 FocalLoss
  2. Semantic-TEDS 评估
    - 论文使用 Semantic-TEDS 作为主要评估指标
    - 需确认 hrdoc_eval.py 的 TEDS 计算是否与论文公式一致：
  TEDS = 1 − EditDist(T_D, T̂_D) / max(|T_D|, |T̂_D|)
  3. Page Embedding（跨页关系）
    - 论文有 page embedding 处理多页文档
    - 需确认当前实现是否支持跨页父节点查找
  4. Attention Pooling 细节
    - 论文：使用加权隐状态计算父节点概率
    - 需确认 ParentFinderGRU 的 attention 机制是否完全对齐

  建议的优化

  # 1. Stage 1 分类损失改用 Focal Loss
  # 在 train_joint.py 的 JointModel 中：
  if use_focal_loss:
      # 修改 stage1 的损失函数为 FocalLoss
      self.cls_criterion = FocalLoss(gamma=2.0)

  # 2. 或者在 run_hrdoc.py 训练时启用：
  python examples/stage/run_hrdoc.py --loss_type focal --focal_gamma 2.0
