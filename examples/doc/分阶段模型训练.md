# HRDoc åˆ†é˜¶æ®µæ¨¡å‹è®­ç»ƒæµç¨‹

https://chatgpt.com/s/t_69173ee0dea08191978d2332ead3faef

https://chatgpt.com/s/t_69173fcea03481918197548ff84ed726

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ HRDoc æ–‡æ¡£å±‚çº§å…³ç³»æå–çš„å®Œæ•´è®­ç»ƒæµç¨‹ã€‚

---

## ğŸ“Š è®­ç»ƒæµç¨‹æ¦‚è§ˆ

HRDoc é‡‡ç”¨**ä¸¤é˜¶æ®µè®­ç»ƒ**ç­–ç•¥ï¼Œå°†ç‰ˆé¢è¯†åˆ«ï¼ˆLayout Understandingï¼‰å’Œå…³ç³»åˆ†ç±»ï¼ˆRelation Classificationï¼‰åˆ†ç¦»è®­ç»ƒï¼Œè€Œä¸æ˜¯ç«¯åˆ°ç«¯ï¼ˆEnd-to-Endï¼‰è®­ç»ƒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HRDoc å®Œæ•´è®­ç»ƒæµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ1: ç‰ˆé¢è¯†åˆ« (Layout Understanding)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥: æ–‡æ¡£å›¾ç‰‡ + æ–‡æœ¬ + ä½ç½®ä¿¡æ¯                           â”‚
â”‚  æ¨¡å‹: LayoutLMv2-base                                     â”‚
â”‚  ä»»åŠ¡: Tokençº§åˆ«çš„NERï¼ˆå‘½åå®ä½“è¯†åˆ«ï¼‰                        â”‚
â”‚  è¾“å‡º: å¾®è°ƒåçš„ LayoutLMv2 æ¨¡å‹                             â”‚
â”‚  æ—¶é—´: ~5åˆ†é’Ÿï¼ˆ50æ­¥ï¼‰/ ~4å°æ—¶ï¼ˆ30000æ­¥ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
é˜¶æ®µ2: æå–è¡Œçº§ç‰¹å¾ (Feature Extraction)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥: å¾®è°ƒåçš„ LayoutLMv2 + æ–‡æ¡£æ•°æ®                        â”‚
â”‚  å¤„ç†: å°† Tokençº§åˆ«ç‰¹å¾èšåˆä¸ºè¡Œçº§ç‰¹å¾                        â”‚
â”‚  è¾“å‡º: line_features.pkl (æ¯è¡Œ768ç»´å‘é‡)                    â”‚
â”‚  æ—¶é—´: ~2-5åˆ†é’Ÿ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
é˜¶æ®µ3: è®­ç»ƒå…³ç³»åˆ†ç±»å™¨ (Relation Classification)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥: è¡Œçº§ç‰¹å¾å‘é‡ï¼ˆå†»ç»“ï¼Œä¸å†æ›´æ–°ï¼‰                        â”‚
â”‚  æ¨¡å‹: å•å±‚çº¿æ€§æŠ•å½± (1536 â†’ 4)                             â”‚
â”‚  ä»»åŠ¡: 4ç±»å…³ç³»åˆ†ç±»ï¼ˆNone/Connect/Contain/Equalityï¼‰         â”‚
â”‚  æŸå¤±: FocalLoss (Î³=2.0)                                   â”‚
â”‚  è¾“å‡º: å…³ç³»åˆ†ç±»å™¨æ¨¡å‹                                        â”‚
â”‚  æ—¶é—´: ~å‡ åˆ†é’Ÿ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é˜¶æ®µ1ï¼šç‰ˆé¢è¯†åˆ«è®­ç»ƒï¼ˆBackboneï¼‰

### ç›®æ ‡
è®­ç»ƒ LayoutLMv2 æ¨¡å‹è¯†åˆ«æ–‡æ¡£ä¸­çš„å„ç§å…ƒç´ ç±»å‹ï¼ˆæ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨ã€è¡¨æ ¼ç­‰ï¼‰ã€‚

### è¾“å…¥æ•°æ®
- **æ–‡æ¡£å›¾ç‰‡**ï¼šåŸå§‹æ–‡æ¡£çš„å›¾åƒ
- **æ–‡æœ¬å†…å®¹**ï¼šOCR æå–çš„æ–‡æœ¬
- **ä½ç½®ä¿¡æ¯**ï¼šæ¯ä¸ª token çš„è¾¹ç•Œæ¡†åæ ‡ `[x0, y0, x1, y1]`

### æ¨¡å‹æ¶æ„
```
LayoutLMv2 = Transformer Encoder
  â”œâ”€ Text Embedding (æ–‡æœ¬åµŒå…¥)
  â”œâ”€ Layout Embedding (ä½ç½®åµŒå…¥)
  â””â”€ Visual Embedding (å›¾åƒç‰¹å¾)

è¾“å‡º: hidden_states [batch_size, seq_len, 768]
```

### è®­ç»ƒä»»åŠ¡
**å‘½åå®ä½“è¯†åˆ«ï¼ˆNERï¼‰**ï¼šä¸ºæ¯ä¸ª token é¢„æµ‹ç±»åˆ«æ ‡ç­¾
- ç±»åˆ«æ•°ï¼š31ç±»ï¼ˆåŒ…æ‹¬æ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨ç­‰ï¼‰
- æŸå¤±å‡½æ•°ï¼šCrossEntropyLoss

### è®­ç»ƒè„šæœ¬
```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆ50æ­¥ï¼Œ~5åˆ†é’Ÿï¼‰
./scripts/train_hrdoc.sh quick

# æœ¬åœ°è®­ç»ƒï¼ˆ1000æ­¥ï¼Œ~1å°æ—¶ï¼‰
./scripts/train_hrdoc.sh local

# å®Œæ•´è®­ç»ƒï¼ˆ30000æ­¥ï¼Œ~4-6å°æ—¶ï¼Œè®ºæ–‡å¯¹é½ï¼‰
./scripts/train_hrdoc_official.sh simple
```

### è¾“å‡ºæ–‡ä»¶
```
/mnt/e/models/train_data/layoutlmft/hrdoc_quick/
â”œâ”€â”€ pytorch_model.bin          # å¾®è°ƒåçš„æ¨¡å‹æƒé‡
â”œâ”€â”€ config.json                # æ¨¡å‹é…ç½®
â”œâ”€â”€ training_args.bin          # è®­ç»ƒå‚æ•°
â””â”€â”€ trainer_state.json         # è®­ç»ƒçŠ¶æ€
```

### å…³é”®é…ç½®
| å‚æ•° | quick | local | cloud (è®ºæ–‡) |
|------|-------|-------|--------------|
| max_steps | 50 | 1000 | 30000 |
| batch_size | 2 | 3 | 3 |
| learning_rate | 5e-5 | 5e-5 | 5e-5 |
| è®­ç»ƒæ—¶é—´ | ~5åˆ†é’Ÿ | ~1å°æ—¶ | ~4-6å°æ—¶ |

---

## é˜¶æ®µ2ï¼šæå–è¡Œçº§ç‰¹å¾ï¼ˆFeature Extractionï¼‰

### ç›®æ ‡
å°† Token çº§åˆ«çš„ hidden states èšåˆä¸ºè¡Œçº§ç‰¹å¾å‘é‡ï¼Œä¾›å…³ç³»åˆ†ç±»å™¨ä½¿ç”¨ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦è¡Œçº§ç‰¹å¾ï¼Ÿ
- **æ–‡æ¡£å±‚çº§å…³ç³»çš„åŸºæœ¬å•ä½æ˜¯"è¡Œ"**ï¼Œè€Œä¸æ˜¯ token
- ä¸€è¡ŒåŒ…å«å¤šä¸ª tokenï¼Œéœ€è¦èšåˆæˆä¸€ä¸ªç‰¹å¾å‘é‡
- èšåˆåçš„ç‰¹å¾å¯ä»¥ç¦»çº¿ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­è®­ç»ƒ

### èšåˆç­–ç•¥
**Mean Poolingï¼ˆé»˜è®¤ï¼‰**ï¼š
```python
# å¯¹å±äºåŒä¸€è¡Œçš„æ‰€æœ‰ token çš„ hidden states å–å¹³å‡
line_feature = mean(hidden_states[line_tokens])  # [768]
```

å…¶ä»–å¯é€‰ç­–ç•¥ï¼š
- **Max Pooling**ï¼šå–æœ€å¤§å€¼
- **First Token**ï¼šå–ç¬¬ä¸€ä¸ª token

### è®­ç»ƒè„šæœ¬
```bash
python examples/extract_line_features.py \
  --model_path /mnt/e/models/train_data/layoutlmft/hrdoc_quick \
  --output_dir /mnt/e/models/train_data/layoutlmft/line_features
```

### è¾“å‡ºæ–‡ä»¶
```
/mnt/e/models/train_data/layoutlmft/line_features/
â”œâ”€â”€ train_line_features.pkl    # è®­ç»ƒé›†è¡Œçº§ç‰¹å¾
â””â”€â”€ val_line_features.pkl      # éªŒè¯é›†è¡Œçº§ç‰¹å¾ï¼ˆå¦‚æœæœ‰ï¼‰
```

### ç‰¹å¾æ–‡ä»¶æ ¼å¼
```python
# train_line_features.pkl å†…å®¹
{
    'features': torch.Tensor,      # [num_lines, 768]
    'line_ids': List[int],         # æ¯è¡Œçš„ID
    'relations': List[str],        # æ¯è¡Œçš„å…³ç³»ç±»å‹
    'parent_ids': List[int],       # æ¯è¡Œçš„çˆ¶èŠ‚ç‚¹ID
    'bboxes': torch.Tensor,        # æ¯è¡Œçš„è¾¹ç•Œæ¡† [num_lines, 4]
}
```

---

## é˜¶æ®µ3ï¼šè®­ç»ƒå…³ç³»åˆ†ç±»å™¨ï¼ˆClassification Headï¼‰

### ç›®æ ‡
åŸºäºè¡Œçº§ç‰¹å¾ï¼Œè®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨é¢„æµ‹ä¸¤è¡Œä¹‹é—´çš„å±‚çº§å…³ç³»ã€‚

### è®ºæ–‡æ–¹æ³•ï¼ˆå½“å‰å®ç°å·²å¯¹é½ï¼‰

#### è¾“å…¥ç‰¹å¾
```python
# æ‹¼æ¥çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹çš„ç‰¹å¾
input = Concat(h_parent, h_child)  # [1536] = [768] + [768]
```

#### ç½‘ç»œæ¶æ„
**å•å±‚çº¿æ€§æŠ•å½±**ï¼ˆä¸¥æ ¼å¯¹é½è®ºæ–‡ï¼‰ï¼š
```python
classifier = nn.Linear(1536, 4)  # 1536 â†’ 4
```

**è®ºæ–‡å…¬å¼**ï¼š
```
P_rel(i,j) = softmax(LinearProj(Concat(h_i, h_j)))
RÌ‚(i,j) = argmax(P_rel(i,j))
```

#### æŸå¤±å‡½æ•°
**FocalLoss**ï¼ˆè®ºæ–‡æŒ‡å®šï¼‰ï¼š
```python
FL(p_t) = -Î±_t(1 - p_t)^Î³ * log(p_t)

# å‚æ•°é…ç½®
criterion = FocalLoss(
    alpha=class_weights,  # ç±»åˆ«æƒé‡
    gamma=2.0             # focusing parameterï¼ˆè®ºæ–‡æ ‡å‡†å€¼ï¼‰
)
```

**FocalLoss ä¼˜åŠ¿**ï¼š
- è‡ªåŠ¨å…³æ³¨éš¾åˆ†ç±»æ ·æœ¬
- æŠ‘åˆ¶æ˜“åˆ†ç±»æ ·æœ¬çš„æ¢¯åº¦è´¡çŒ®
- æ›´é€‚åˆæåº¦ä¸å¹³è¡¡çš„æ•°æ®ï¼ˆå¦‚ equality ç±»åˆ«å¾ˆå°‘ï¼‰

#### å…³ç³»ç±»å‹ï¼ˆ4ç±»ï¼‰
| ID | ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|----|------|------|------|
| 0 | None | æ— å…³ç³» | éšæœºé€‰æ‹©çš„ä¸¤è¡Œ |
| 1 | Connect | è¯­ä¹‰è¿æ¥ | æ®µè½ä¸­çš„è¿ç»­è¡Œ |
| 2 | Contain | åŒ…å«å…³ç³» | ç« èŠ‚åŒ…å«å­ç« èŠ‚ |
| 3 | Equality | åŒçº§å…³ç³» | åŒä¸€ç« èŠ‚ä¸‹çš„ä¸åŒå­ç« èŠ‚ |

### è®­ç»ƒè„šæœ¬
```bash
python examples/train_multiclass_relation.py \
  --features_file /mnt/e/models/train_data/layoutlmft/line_features/train_line_features.pkl \
  --output_dir /mnt/e/models/train_data/layoutlmft/multiclass_relation \
  --max_steps 1000 \
  --batch_size 32
```

### è¾“å‡ºæ–‡ä»¶
```
/mnt/e/models/train_data/layoutlmft/multiclass_relation/
â”œâ”€â”€ best_model.pth             # æœ€ä½³æ¨¡å‹æƒé‡
â”œâ”€â”€ training_log.txt           # è®­ç»ƒæ—¥å¿—
â””â”€â”€ confusion_matrix.png       # æ··æ·†çŸ©é˜µï¼ˆå¯é€‰ï¼‰
```

### è´Ÿé‡‡æ ·ç­–ç•¥
ä¸ºäº†å¹³è¡¡æ•°æ®ï¼Œå¯¹ None ç±»åˆ«è¿›è¡Œè´Ÿé‡‡æ ·ï¼š
```python
# å¯¹æ¯ä¸ªæ­£æ ·æœ¬ï¼ˆConnect/Contain/Equalityï¼‰ï¼Œ
# éšæœºé‡‡æ · 3 ä¸ªè´Ÿæ ·æœ¬ï¼ˆNoneï¼‰
neg_ratio = 3

# è´Ÿæ ·æœ¬é€‰æ‹©è§„åˆ™ï¼š
# - åŒä¸€é¡µé¢å†…
# - åœ¨ child ä¹‹å‰çš„è¡Œ
# - æ’é™¤çœŸå®çš„ parent
```

---

## ğŸ”‘ ä¸ºä»€ä¹ˆé‡‡ç”¨åˆ†é˜¶æ®µè®­ç»ƒï¼Ÿ

### 1. è®­ç»ƒæ•ˆç‡
- **LayoutLMv2 è®­ç»ƒå¾ˆæ…¢**ï¼šéœ€è¦åŠ è½½å›¾ç‰‡ã€å¤„ç†è§†è§‰ç‰¹å¾ï¼ŒGPU å¯†é›†
- **å…³ç³»åˆ†ç±»å¤´è®­ç»ƒå¾ˆå¿«**ï¼šåªç”¨ç‰¹å¾å‘é‡ï¼Œå¯ä»¥åœ¨ CPU ä¸Šå¿«é€Ÿå®éªŒ

### 2. çµæ´»æ€§
- å¯ä»¥ç”¨åŒä¸€ä¸ª LayoutLMv2 backbone å°è¯•ä¸åŒçš„å…³ç³»åˆ†ç±»ç­–ç•¥
- æ— éœ€é‡å¤è®­ç»ƒè€—æ—¶çš„ backbone

### 3. å¯è§£é‡Šæ€§
- ç‰¹å¾æå–å’Œå…³ç³»åˆ†ç±»èŒè´£åˆ†ç¦»
- ä¾¿äºè°ƒè¯•å’Œåˆ†æ

### 4. è®ºæ–‡å¤ç°
- HRDoc è®ºæ–‡é‡‡ç”¨çš„ä¹Ÿæ˜¯è¿™ç§ä¸¤é˜¶æ®µæ–¹æ³•
- ä¸¥æ ¼å¯¹é½è®ºæ–‡ä¾¿äºç»“æœå¯¹æ¯”

---

## ğŸ“ˆ è®ºæ–‡å¯¹é½æƒ…å†µ

### å®Œå…¨å¯¹é½ âœ…

| ç»„ä»¶ | è®ºæ–‡è¦æ±‚ | å½“å‰å®ç° | çŠ¶æ€ |
|------|---------|---------|------|
| å…³ç³»ç±»å‹ | Connect/Contain/Equality | 4ç±»ï¼ˆå¢åŠ Noneï¼‰ | âœ… å¯¹é½ |
| è¾“å…¥ç‰¹å¾ | Concat(h_i, h_j) | Concat(h_parent, h_child) | âœ… å¯¹é½ |
| ç½‘ç»œæ¶æ„ | å•å±‚çº¿æ€§æŠ•å½± | nn.Linear(1536, 4) | âœ… å¯¹é½ |
| æŸå¤±å‡½æ•° | FocalLoss | FocalLoss(Î±, Î³=2.0) | âœ… å¯¹é½ |
| è®­ç»ƒæ­¥æ•° | 30000æ­¥ | å¯é…ç½®ï¼ˆquick/local/cloudï¼‰ | âœ… å¯¹é½ |

### åˆç†æ‰©å±• ğŸ”§

- **None ç±»åˆ«**ï¼šè®ºæ–‡æœªæ˜ç¡®è¯´æ˜è´Ÿæ ·æœ¬ï¼Œæˆ‘ä»¬å¢åŠ äº† None ç±»åˆ«
- **å‡ ä½•ç‰¹å¾**ï¼šå¯é€‰çš„å¢å¼ºç‰¹å¾ï¼ˆé»˜è®¤å…³é—­ï¼Œä¸¥æ ¼å¯¹é½è®ºæ–‡ï¼‰
- **è´Ÿé‡‡æ ·ç­–ç•¥**ï¼šåˆç†çš„è´Ÿæ ·æœ¬é‡‡æ ·æ–¹æ³•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®Œæ•´è®­ç»ƒæµç¨‹ï¼ˆ3æ¡å‘½ä»¤ï¼‰

```bash
# 1. ç‰ˆé¢è¯†åˆ«è®­ç»ƒï¼ˆå¿«é€Ÿæµ‹è¯•ç‰ˆï¼‰
./scripts/train_hrdoc.sh quick
# è¾“å‡º: /mnt/e/models/train_data/layoutlmft/hrdoc_quick/

# 2. æå–è¡Œçº§ç‰¹å¾
export LAYOUTLMFT_MODEL_PATH=/mnt/e/models/train_data/layoutlmft/hrdoc_quick
export LAYOUTLMFT_FEATURES_DIR=/mnt/e/models/train_data/layoutlmft/line_features
python examples/extract_line_features.py

# 3. è®­ç»ƒå…³ç³»åˆ†ç±»å™¨ï¼ˆè®ºæ–‡å¯¹é½ç‰ˆæœ¬ï¼‰
python examples/train_multiclass_relation.py
# è¾“å‡º: /mnt/e/models/train_data/layoutlmft/multiclass_relation/
```

### è®ºæ–‡å®Œæ•´å¤ç°ï¼ˆäº‘æœåŠ¡å™¨ï¼‰

```bash
# 1. å®Œæ•´ç‰ˆé¢è¯†åˆ«è®­ç»ƒï¼ˆ30000æ­¥ï¼Œ4-6å°æ—¶ï¼‰
./scripts/train_hrdoc_official.sh simple

# 2. æå–ç‰¹å¾
python examples/extract_line_features.py \
  --model_path ./output/hrdoc_simple_full

# 3. è®­ç»ƒå…³ç³»åˆ†ç±»å™¨
python examples/train_multiclass_relation.py \
  --max_steps 10000
```

---

## ğŸ“Š é¢„æœŸæ€§èƒ½

### ç‰ˆé¢è¯†åˆ«ï¼ˆé˜¶æ®µ1ï¼‰
- **Quick (50æ­¥)**ï¼šå¿«é€ŸéªŒè¯æµç¨‹ï¼Œç²¾åº¦è¾ƒä½
- **Local (1000æ­¥)**ï¼šä¸­ç­‰ç²¾åº¦ï¼Œé€‚åˆæœ¬åœ°å¼€å‘
- **Cloud (30000æ­¥)**ï¼šè®ºæ–‡çº§åˆ«ç²¾åº¦ï¼ŒF1 > 90%

### å…³ç³»åˆ†ç±»ï¼ˆé˜¶æ®µ3ï¼‰
ä½¿ç”¨ **FocalLoss** é¢„æœŸæ•ˆæœï¼š
- **Connect**: F1 ~85-90%ï¼ˆæ•°æ®å……è¶³ï¼‰
- **Contain**: F1 ~80-85%ï¼ˆä¸­ç­‰æ•°æ®ï¼‰
- **Equality**: F1 ~70-80%ï¼ˆæ•°æ®è¾ƒå°‘ï¼ŒFocalLoss å¸®åŠ©å¾ˆå¤§ï¼‰
- **Overall**: F1 ~80-85%

å¯¹æ¯” **CrossEntropyLoss**ï¼ˆæ—§ç‰ˆæœ¬ï¼‰ï¼š
- é¢„æœŸæ€§èƒ½æå‡ **5-10%**ï¼ˆå°¤å…¶æ˜¯å°‘æ ·æœ¬ç±»åˆ«ï¼‰

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é˜¶æ®µ1 é—®é¢˜

**Q: è®­ç»ƒå¤±è´¥ "Invalid URL"**
A: transformers 4.5.1 çš„ bugï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å‹è·¯å¾„è€Œä¸æ˜¯æ¨¡å‹åï¼š
```bash
# config ä¸­å·²é…ç½® local_model_path
--model_name_or_path /mnt/e/models/HuggingFace/hub/models--microsoft--layoutlmv2-base-uncased/...
```

**Q: ç£ç›˜ç©ºé—´ä¸è¶³**
A: æ‰€æœ‰è¾“å‡ºå·²é‡å®šå‘åˆ° E ç›˜ï¼š
```bash
export LAYOUTLMFT_OUTPUT_DIR=/mnt/e/models/train_data/layoutlmft
```

### é˜¶æ®µ2 é—®é¢˜

**Q: æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶**
A: è®¾ç½®æ­£ç¡®çš„æ¨¡å‹è·¯å¾„ï¼š
```bash
export LAYOUTLMFT_MODEL_PATH=/mnt/e/models/train_data/layoutlmft/hrdoc_quick
```

### é˜¶æ®µ3 é—®é¢˜

**Q: æ‰¾ä¸åˆ°ç‰¹å¾æ–‡ä»¶**
A: ç¡®ä¿é˜¶æ®µ2å·²å®Œæˆï¼Œå¹¶è®¾ç½®ï¼š
```bash
export LAYOUTLMFT_FEATURES_DIR=/mnt/e/models/train_data/layoutlmft/line_features
```

**Q: ç±»åˆ«ä¸å¹³è¡¡å¯¼è‡´æ•ˆæœå·®**
A: å·²ä½¿ç”¨ FocalLoss + ç±»åˆ«æƒé‡ï¼Œè‡ªåŠ¨å¤„ç†

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **HRDoc è®ºæ–‡**: https://ar5iv.labs.arxiv.org/html/2303.13839
- **FocalLoss åŸè®ºæ–‡**: Lin et al. "Focal Loss for Dense Object Detection" (ICCV 2017)
- **LayoutLMv2**: https://huggingface.co/microsoft/layoutlmv2-base-uncased

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-11-14**: åˆ›å»ºæ–‡æ¡£ï¼Œè¯¦ç»†è¯´æ˜åˆ†é˜¶æ®µè®­ç»ƒæµç¨‹
- **2025-11-14**: ä¸¥æ ¼å¯¹é½ HRDoc è®ºæ–‡ï¼ˆFocalLoss + å•å±‚çº¿æ€§ï¼‰

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-14
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

# ä¸‰é˜¶æ®µä»»åŠ¡

  1. ä»»åŠ¡å®šä¹‰

  - ç›®æ ‡: é¢„æµ‹ä¸¤è¡Œ(unit)ä¹‹é—´çš„å±‚çº§å…³ç³»
  - 4ç±»å…³ç³»:
    - None (0): æ— å…³ç³»
    - Connect (1): è¯­ä¹‰è¿æ¥(å¦‚æ®µè½ä¸­çš„è¿ç»­è¡Œ)
    - Contain (2): åŒ…å«å…³ç³»(å¦‚ç« èŠ‚åŒ…å«å­ç« èŠ‚)
    - Equality (3): åŒçº§å…³ç³»(å¦‚åŒä¸€ç« èŠ‚ä¸‹çš„ä¸åŒå­ç« èŠ‚)

  2. Unit-Pair é€‰å–ç­–ç•¥

  æ­£æ ·æœ¬ (Connect/Contain/Equality)

  ä»æ•°æ®é›†çš„line_parent_idså’Œline_relationså­—æ®µç›´æ¥è·å–:

  # å¯¹äºæ¯ä¸€é¡µçš„æ•°æ®
  for line_idx, (parent_id, relation) in enumerate(zip(line_parent_ids, line_relations)):
      if parent_id >= 0:  # æœ‰çˆ¶èŠ‚ç‚¹
          # åˆ›å»º (parent, child) pair
          pair = (parent_id, line_idx)
          label = relation_to_label[relation]  # "connect"â†’1, "contain"â†’2, "equality"â†’3

  è´Ÿæ ·æœ¬ (None)

  éœ€è¦é‡‡æ ·,ç­–ç•¥å¦‚ä¸‹:

  # è´Ÿé‡‡æ ·ç­–ç•¥ï¼ˆè®ºæ–‡å¯¹é½ï¼‰
  for child_idx in range(num_lines):
      parent_id = line_parent_ids[child_idx]

      # åœ¨åŒä¸€é¡µå†…é‡‡æ · negative pairs
      # è§„åˆ™: é€‰æ‹©childä¹‹å‰çš„è¡Œ,ä½†æ’é™¤çœŸå®çš„parent
      candidates = []
      for i in range(child_idx):
          if i != parent_id:  # ä¸æ˜¯çœŸå®çš„parent
              candidates.append(i)

      # æ¯ä¸ªæ­£æ ·æœ¬é‡‡æ · neg_ratio ä¸ªè´Ÿæ ·æœ¬
      neg_ratio = 3  # å¸¸è§è®¾ç½®: 1:3 æ­£è´Ÿæ¯”
      num_neg = min(neg_ratio, len(candidates))
      negatives = random.sample(candidates, num_neg)

      for neg_parent in negatives:
          pairs.append((neg_parent, child_idx))
          labels.append(0)  # None

  è´Ÿé‡‡æ ·åŸåˆ™:
  - åªåœ¨åŒä¸€é¡µå†…é‡‡æ ·
  - åªé€‰childä¹‹å‰çš„è¡Œ(å› ä¸ºparenté€šå¸¸åœ¨å‰)
  - æ’é™¤çœŸå®parent
  - æ§åˆ¶æ­£è´Ÿæ¯”ä¾‹(1:3)é¿å…ç±»åˆ«æåº¦ä¸å¹³è¡¡

  3. ç‰¹å¾æ‹¼æ¥

  # å¯¹äºpair (parent_id, child_id)
  h_parent = line_features[parent_id]  # [768]
  h_child = line_features[child_id]    # [768]

  # è®ºæ–‡æ–¹æ³•: ç®€å•æ‹¼æ¥
  input_feature = concat(h_parent, h_child)  # [1536]

  # å¯é€‰çš„å‡ ä½•ç‰¹å¾ (bboxè·ç¦»ç­‰,è®ºæ–‡æœªç”¨)
  # geo_feature = compute_geometry(line_bboxes[parent_id], line_bboxes[child_id])
  # input_feature = concat(h_parent, h_child, geo_feature)

  4. æ¨¡å‹æ¶æ„

  # ä¸¥æ ¼å¯¹é½è®ºæ–‡: å•å±‚çº¿æ€§æŠ•å½±
  classifier = nn.Linear(1536, 4)

  # å‰å‘ä¼ æ’­
  logits = classifier(input_feature)  # [4]
  pred = torch.argmax(logits)  # é¢„æµ‹ç±»åˆ«

  5. æŸå¤±å‡½æ•°

  # FocalLoss (è®ºæ–‡æŒ‡å®š)
  criterion = FocalLoss(
      alpha=class_weights,  # ç±»åˆ«æƒé‡ (æ ¹æ®æ•°æ®åˆ†å¸ƒ)
      gamma=2.0             # focusing parameter
  )

  loss = criterion(logits, label)

  ä¸ºä»€ä¹ˆç”¨ FocalLoss?
  - æ•°æ®æåº¦ä¸å¹³è¡¡: Equalityç±»åˆ«å¾ˆå°‘
  - è‡ªåŠ¨å…³æ³¨éš¾åˆ†ç±»æ ·æœ¬
  - æŠ‘åˆ¶æ˜“åˆ†ç±»æ ·æœ¬çš„æ¢¯åº¦è´¡çŒ®

  6. è®­ç»ƒæµç¨‹

  1. åŠ è½½ç‰¹å¾: train_line_features.pkl
  2. æ„å»ºpairs:
     - æ­£æ ·æœ¬: ä»line_parent_idsæå–
     - è´Ÿæ ·æœ¬: æŒ‰1:3æ¯”ä¾‹é‡‡æ ·
  3. æ•°æ®è¿­ä»£:
     æ¯ä¸ªepoch:
       for batch in dataloader:
         features = concat(h_parent, h_child)
         logits = model(features)
         loss = focal_loss(logits, labels)
         loss.backward()
         optimizer.step()
  4. éªŒè¯: åœ¨validé›†è¯„ä¼°F1
  5. ä¿å­˜æœ€ä½³æ¨¡å‹
